shnitsel.clean.filter_geo
=========================

.. py:module:: shnitsel.clean.filter_geo


Attributes
----------

.. autoapisummary::

   shnitsel.clean.filter_geo.TrajectoryOrFrames


Classes
-------

.. autoapisummary::

   shnitsel.clean.filter_geo.GeometryFiltrationThresholds


Functions
---------

.. autoapisummary::

   shnitsel.clean.filter_geo.calculate_bond_length_filtranda
   shnitsel.clean.filter_geo.filter_by_length


Module Contents
---------------

.. py:data:: TrajectoryOrFrames

.. py:class:: GeometryFiltrationThresholds(settings = None)

   Helper class to keep an extensible set of threshold values for various geometric
   filtration properties.
   The dictionary `match_thresholds` maps SMARTS to a threshold for the length of the bonds described by these SMARTS.
   Additionally, this class has a `length_unit` field which specifies the unit that all other constraints are given in.
   By default, the unit is `angstrom`.

   TODO: FIXME: Should probably provide properties that automatically write to the dict instead.


   .. py:attribute:: all_bonds_threshold
      :type:  float
      :value: 3.0



   .. py:attribute:: all_bonds_smarts
      :type:  str
      :value: '[*]~[*]'



   .. py:attribute:: all_h_to_C_or_N_bonds_threshold
      :type:  float
      :value: 2.0



   .. py:attribute:: all_h_to_C_or_N_bonds_SMARTS
      :type:  str
      :value: '[#6,#7][H]'



   .. py:attribute:: length_unit
      :type:  str
      :value: 'Angstrom'



   .. py:attribute:: match_thresholds
      :type:  dict[str, float] | None
      :value: None



   .. py:method:: get_full_match_dict()

      Get the full dictionary of SMARTs strings and associated bond length thresholds.

      Used to incorporate settings that are available as explicit fields of this class into the match_thresholds dict.

      :returns: The combination of settings that can be set via the fields in this class and the `match_thresholds` dict.
      :rtype: dict[str, float]



   .. py:method:: to_dataarray(selected_SMARTS = None)

      Helper function to convert this dataclass object into an xarray.DataArray to be
      assigned to the coordinate of a Filtration dataset.

      :param selected_criteria: The sequence of criteria keys to be a result of the conversion. Defaults to None.
                                Must be a subset of the keys of fields on this object if not set to None.
                                If set to None, all but the unit field in this object will be used to set the
                                list of criterion keys.
      :type selected_criteria: Sequence[str] | None, optional

      :returns:     A DataArray with a 'criterion' coordinate with either all available or all
                    selected properties and the threshold values in the array cells.
      :rtype: xr.DataArray



.. py:function:: calculate_bond_length_filtranda(frames, geometry_thresholds = None, mol = None)

   Derive bond length filtration targets from an xr.Dataset

   :param frames: A xr.Dataset with an ``atXYZ`` variable
   :param geometry_thresholds:
                               A mapping from SMARTS-strings to length-thresholds.

                                   - The SMARTS-strings describe bonds which are searched
                                       for in an RDKit Mol object obtained via :py:func:`shnitsel.bridges.default_mol`
                                   - The thresholds describe maximal tolerable bond-lengths; if there are multiple matches
                                       for a given search, the longest bond-length will be considered for each frame
                                   - The unit for the maximum length is provided in the member variable `length_unit` which defaults to `angstrom`.
                                   - If not provided will be initialized with thresholds for H-(C/N) bonds and one for all bonds.
   :param optional:
                    A mapping from SMARTS-strings to length-thresholds.

                        - The SMARTS-strings describe bonds which are searched
                            for in an RDKit Mol object obtained via :py:func:`shnitsel.bridges.default_mol`
                        - The thresholds describe maximal tolerable bond-lengths; if there are multiple matches
                            for a given search, the longest bond-length will be considered for each frame
                        - The unit for the maximum length is provided in the member variable `length_unit` which defaults to `angstrom`.
                        - If not provided will be initialized with thresholds for H-(C/N) bonds and one for all bonds.
   :param mol: Optional `Mol` object to perform SMARTs matching on.

               TODO: FIXME: We should be able to provide a StructureSelection instead.
   :param optional: Optional `Mol` object to perform SMARTs matching on.

                    TODO: FIXME: We should be able to provide a StructureSelection instead.

   :returns: * An xr.DataArray of filtration targets stacked along the ``criterion`` dimension;
             * one criterion per ``search_dict`` entry.


.. py:function:: filter_by_length(frames_or_trajectory, filter_method = 'truncate', *, geometry_thresholds = None, mol = None, plot_thresholds = False, plot_populations = False)

   Filter trajectories according to bond length

   :param frames_or_trajectory: A Trajectory or Frames Dataset with an ``atXYZ`` variable (NB. this function takes an xr.Dataset as
                                opposed to an xr.DataArray for consistency with :py:func:`shnitsel.clean.filter_by_energy`)
   :type frames_or_trajectory: Trajectory | Frames | xr.Dataset
   :param filter_method:
                         Specifies the manner in which to remove data;

                             - if 'omit', drop trajectories unless all frames meet criteria (:py:func:`shnitsel.clean.omit`)
                             - if 'truncate', cut each trajectory off just before the first frame that doesn't meet criteria
                                 (:py:func:`shnitsel.clean.truncate`)
                             - if 'annotate', merely annotate the data;
                             - if a `float` number, interpret this number as a time, and cut all trajectories off at this time,
                                 discarding those which violate criteria before reaching the given limit,
                                 (:py:func:`shnitsel.clean.transect`)
                         see :py:func:`shnitsel.clean.dispatch_filter`.
   :type filter_method: Literal["truncate", "omit", "annotate"] | float, optional
   :param geometry_thresholds:
                               A mapping from SMARTS-strings to length-thresholds.

                                   - The SMARTS-strings describe bonds which are searched
                                       for in an RDKit Mol object obtained via :py:func:`shnitsel.bridges.default_mol`
                                   - The thresholds describe maximal tolerable bond-lengths; if there are multiple matches
                                       for a given search, the longest bond-length will be considered for each frame
                                   - The unit for the maximum length is provided in the member variable `length_unit` which defaults to `angstrom`.
                                   - If not provided will be initialized with thresholds for H-(C/N) bonds and one for all bonds.
   :type geometry_thresholds: GeometryFiltrationThresholds, optional
   :param mol: An rdkit mol object, if not provided it will be generated from the XYZ coordinates in the data
               See :py:func:`shnitsel.vis.plot.filtration.check_thresholds`.

               - If ``True``, will plot using ``check_thresholds`` with
               default quantiles
               - If a ``Sequence``, will plot using ``check_thresholds``
               with specified quantiles
               - If ``False``, will not plot threshold plot
   :type mol: Mol, optional
   :param plot_populations: See :py:func:`shnitsel.vis.plot.filtration.validity_populations`.

                            - If ``'intersections'``, will plot populations of
                            trajectories satisfying intersecting conditions
                            - If ``'independent'``, will plot populations of
                            trajectories satisfying conditions taken independently
                            - If ``False``, will not plot populations plot
   :type plot_populations: Literal["independent", "intersections", False], optional

   :rtype: The filtered Dataset or None if the filter method results in the trajectory being rejected.

   .. rubric:: Notes

   The resulting object has a ``filtranda`` data_var, representing the values by which the data were filtered.
   If the input has a ``filtranda`` data_var, it is overwritten. An existing 'criterion' dimension will be dropped from
   the `frames_or_trajectory` parameter along with all variables and coordinates tied to it.


