shnitsel.clean
==============

.. py:module:: shnitsel.clean


Submodules
----------

.. toctree::
   :maxdepth: 1

   /api/shnitsel/clean/common/index
   /api/shnitsel/clean/dispatch_plots/index
   /api/shnitsel/clean/filter_energy/index
   /api/shnitsel/clean/filter_geo/index
   /api/shnitsel/clean/filtration_class/index


Functions
---------

.. autoapisummary::

   shnitsel.clean.filter_by_energy
   shnitsel.clean.filter_by_length
   shnitsel.clean.sanity_check


Package Contents
----------------

.. py:function:: filter_by_energy(frames_or_trajectory, filter_method = 'truncate', *, energy_thresholds = None, plot_thresholds = False, plot_populations = False)

   Filter trajectories according to energy to exclude unphysical (insane) behaviour

   :param frames_or_trajectory: A Frames or Trajectory object with ``astate``, ``energy``, and ideally ``e_kin`` variables.
                                If ``astate`` is not set, no filtering will be performed and no filtranda assigned.
   :param filter_method:
                         Specifies the manner in which to remove data;

                             - if 'omit', drop trajectories unless all frames meet criteria (:py:func:`shnitsel.clean.omit`)
                             - if 'truncate', cut each trajectory off just before the first frame that doesn't meet criteria
                                 (:py:func:`shnitsel.clean.truncate`)
                             - if 'annotate', merely annotate the data;
                             - if a `float` number, interpret this number as a time, and cut all trajectories off at this time,
                                 discarding those which violate criteria before reaching the given limit,
                                 (:py:func:`shnitsel.clean.transect`)
                         see :py:func:`shnitsel.clean.dispatch_filter`.
   :param optional:
                    Specifies the manner in which to remove data;

                        - if 'omit', drop trajectories unless all frames meet criteria (:py:func:`shnitsel.clean.omit`)
                        - if 'truncate', cut each trajectory off just before the first frame that doesn't meet criteria
                            (:py:func:`shnitsel.clean.truncate`)
                        - if 'annotate', merely annotate the data;
                        - if a `float` number, interpret this number as a time, and cut all trajectories off at this time,
                            discarding those which violate criteria before reaching the given limit,
                            (:py:func:`shnitsel.clean.transect`)
                    see :py:func:`shnitsel.clean.dispatch_filter`.
   :param energy_thresholds: Threshold for total, potential and kinetic energy of the system.
                             Can specify thresholds for overall drift and individual time step changes.
                             Can also specify thresholds for energy steps at hops.
                             Unit should be specified as a member variable.
                             If not provided will default to some reasonable default values as seen in `EnergyThresholds` definition.
   :param optional: Threshold for total, potential and kinetic energy of the system.
                    Can specify thresholds for overall drift and individual time step changes.
                    Can also specify thresholds for energy steps at hops.
                    Unit should be specified as a member variable.
                    If not provided will default to some reasonable default values as seen in `EnergyThresholds` definition.
   :param plot_thresholds: See :py:func:`shnitsel.vis.plot.filtration.check_thresholds`.

                           - If ``True``, will plot using ``check_thresholds`` with
                           default quantiles
                           - If a ``Sequence``, will plot using ``check_thresholds``
                           with specified quantiles
                           - If ``False`` (the default), will not plot threshold plot
   :param plot_populations: See :py:func:`shnitsel.vis.plot.filtration.validity_populations`.

                            - If ``'intersections'``, will plot populations of
                            trajectories satisfying intersecting conditions
                            - If ``'independent'``, will plot populations of
                            trajectories satisfying conditions taken independently
                            - If ``False`` (the default), will not plot populations plot

   :rtype: The sanitized xr.Dataset

   .. rubric:: Notes

   The resulting object has a ``filtranda`` data_var, representing the values by which the data were filtered.
   If the input has a ``filtranda`` data_var, it is overwritten.


.. py:function:: filter_by_length(frames_or_trajectory, filter_method = 'truncate', *, geometry_thresholds = None, mol = None, plot_thresholds = False, plot_populations = False)

   Filter trajectories according to bond length

   :param frames_or_trajectory: A Trajectory or Frames Dataset with an ``atXYZ`` variable (NB. this function takes an xr.Dataset as
                                opposed to an xr.DataArray for consistency with :py:func:`shnitsel.clean.filter_by_energy`)
   :type frames_or_trajectory: Trajectory | Frames | xr.Dataset
   :param filter_method:
                         Specifies the manner in which to remove data;

                             - if 'omit', drop trajectories unless all frames meet criteria (:py:func:`shnitsel.clean.omit`)
                             - if 'truncate', cut each trajectory off just before the first frame that doesn't meet criteria
                                 (:py:func:`shnitsel.clean.truncate`)
                             - if 'annotate', merely annotate the data;
                             - if a `float` number, interpret this number as a time, and cut all trajectories off at this time,
                                 discarding those which violate criteria before reaching the given limit,
                                 (:py:func:`shnitsel.clean.transect`)
                         see :py:func:`shnitsel.clean.dispatch_filter`.
   :type filter_method: Literal["truncate", "omit", "annotate"] | float, optional
   :param geometry_thresholds:
                               A mapping from SMARTS-strings to length-thresholds.

                                   - The SMARTS-strings describe bonds which are searched
                                       for in an RDKit Mol object obtained via :py:func:`shnitsel.bridges.default_mol`
                                   - The thresholds describe maximal tolerable bond-lengths; if there are multiple matches
                                       for a given search, the longest bond-length will be considered for each frame
                                   - The unit for the maximum length is provided in the member variable `length_unit` which defaults to `angstrom`.
                                   - If not provided will be initialized with thresholds for H-(C/N) bonds and one for all bonds.
   :type geometry_thresholds: GeometryFiltrationThresholds, optional
   :param mol: An rdkit mol object, if not provided it will be generated from the XYZ coordinates in the data
               See :py:func:`shnitsel.vis.plot.filtration.check_thresholds`.

               - If ``True``, will plot using ``check_thresholds`` with
               default quantiles
               - If a ``Sequence``, will plot using ``check_thresholds``
               with specified quantiles
               - If ``False``, will not plot threshold plot
   :type mol: Mol, optional
   :param plot_populations: See :py:func:`shnitsel.vis.plot.filtration.validity_populations`.

                            - If ``'intersections'``, will plot populations of
                            trajectories satisfying intersecting conditions
                            - If ``'independent'``, will plot populations of
                            trajectories satisfying conditions taken independently
                            - If ``False``, will not plot populations plot
   :type plot_populations: Literal["independent", "intersections", False], optional

   :rtype: The filtered Dataset or None if the filter method results in the trajectory being rejected.

   .. rubric:: Notes

   The resulting object has a ``filtranda`` data_var, representing the values by which the data were filtered.
   If the input has a ``filtranda`` data_var, it is overwritten. An existing 'criterion' dimension will be dropped from
   the `frames_or_trajectory` parameter along with all variables and coordinates tied to it.


.. py:function:: sanity_check(trajectory_or_frames, filter_method = 'truncate', *, energy_thresholds = None, geometry_thresholds = None, plot_thresholds = False, plot_populations = False, mol = None, drop_empty_trajectories = False)

   Filter trajectories according to energy to exclude unphysical (insane) behaviour

   :param trajectory_or_frames: A Trajectory or Frames object (or a ShnitselDB structure holding such objects) with an ``atXYZ`` variable as well as ``astate``, ``energy``, and ideally ``e_kin`` variables
   :type trajectory_or_frames: Trajectory | Frames | TreeNode[Any, Trajectory|Frames]
   :param filter_method:
                         Specifies the manner in which to remove data;
                             - if 'omit', drop trajectories unless all frames meet criteria (:py:func:`shnitsel.clean.omit`)
                             - if 'truncate', cut each trajectory off just before the first frame that doesn't meet criteria
                                 (:py:func:`shnitsel.clean.truncate`)
                             - if 'annotate', merely annotate the data;
                             - if a `float` number, interpret this number as a time, and cut all trajectories off at this time,
                                 discarding those which violate criteria before reaching the given limit,
                                 (:py:func:`shnitsel.clean.transect`)
                         see :py:func:`shnitsel.clean.dispatch_filter`.
   :type filter_method: Literal["truncate", "omit", "annotate"] | float, optional
   :param energy_thresholds: Threshold for total, potential and kinetic energy of the system.
                             Can specify thresholds for overall drift and individual time step changes.
                             Can also specify thresholds for energy steps at hops.
                             Unit should be specified as a member variable.
                             If not provided will default to some reasonable default values as seen in `EnergyThresholds` definition.
   :type energy_thresholds: EnergyFiltrationThresholds, optional
   :param geometry_thresholds:
                               A mapping from SMARTS-strings to length-thresholds.

                                   - The SMARTS-strings describe bonds which are searched
                                       for in an RDKit Mol object obtained via :py:func:`shnitsel.bridges.default_mol`
                                   - The thresholds describe maximal tolerable bond-lengths; if there are multiple matches
                                       for a given search, the longest bond-length will be considered for each frame
                                   - The unit for the maximum length is provided in the member variable `length_unit` which defaults to `angstrom`.
                                   - If not provided will be initialized with thresholds for H-(C/N) bonds and one for all bonds.
   :type geometry_thresholds: GeometryFiltrationThresholds, optional
   :param plot_thresholds: See :py:func:`shnitsel.vis.plot.filtration.check_thresholds`.

                           - If ``True``, will plot using ``check_thresholds`` with
                           default quantiles
                           - If a ``Sequence``, will plot using ``check_thresholds``
                           with specified quantiles
                           - If ``False``, will not plot threshold plot
   :type plot_thresholds: bool, optional
   :param plot_populations: See :py:func:`shnitsel.vis.plot.filtration.validity_populations`.

                            - If ``'intersections'``, will plot populations of
                            trajectories satisfying intersecting conditions
                            - If ``'independent'``, will plot populations of
                            trajectories satisfying conditions taken independently
                            - If ``False``, will not plot populations plot
   :type plot_populations: Literal ['intersections', 'independent', False], optional
   :param mol: Optional parameter to provide a mol object to base structure analysis on, by default generated from the first frame in the trajectory or frameset.
   :type mol: rdkit.Chem.Mol, optional
   :param drop_empty_trajectories: Flag to not include trajectories for which the sanity check result was empty in the final result tree, by default False.
                                   Only used for tree-structure inputs.
   :type drop_empty_trajectories: bool, optional

   :returns: * *The sanitized trajectory, frames or tree.*
             * *A tree is sanitized by applying the sanitization function to all individual data points in the tree.*

   .. rubric:: Notes

   The resulting object has a ``energy_filtranda`` and a ``geometry_filtranda`` data_var, representing the values by which the data were filtered.
   If the input has a ``filtranda`` data_var, it is overwritten.
   If the input has a `criterion` dimension, it will be dropped.


